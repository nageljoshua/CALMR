<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CALMR">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="#" id="manifest-placeholder">
    <title>CALMR Check-In App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 28px;
        }

        h2 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 22px;
        }

        h3 {
            color: #555;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .button-icon {
            font-size: 24px;
            min-width: 32px;
            text-align: center;
        }

        .secondary-button {
            background: #e0e7ff;
            color: #667eea;
        }

        .secondary-button:hover {
            background: #c7d2fe;
        }

        .danger-button {
            background: #ef4444;
        }

        .danger-button:hover {
            background: #dc2626;
        }

        .question-section {
            margin-bottom: 24px;
        }

        .question-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: #e0e7ff;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .radio-button {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-button:hover {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .radio-button.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .expandable-text {
            margin-top: 8px;
        }

        .expand-toggle {
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .expand-toggle:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .navigation-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .nav-button {
            flex: 1;
        }

        .back-button {
            background: #94a3b8;
        }

        .back-button:hover {
            background: #64748b;
        }

        .mantra-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-style: italic;
            color: #92400e;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            color: #1e40af;
            font-size: 14px;
        }

        .body-map {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .body-part {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .body-part:hover {
            border-color: #667eea;
        }

        .body-part.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .breathing-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #667eea;
            margin: 32px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            animation: breathe 6s infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .home-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .home-icon:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .time-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(23px);
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }
            
            .card {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .modal {
                padding: 12px;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        // ============= STATE MANAGEMENT =============
        const state = {
            currentView: 'home',
            currentStep: 0,
            sessionData: {},
            history: [],
            inProgressSession: null
        };

        // Load saved data from localStorage
        function loadData() {
            const saved = localStorage.getItem('calmrData');
            if (saved) {
                const data = JSON.parse(saved);
                state.history = data.history || [];
                state.inProgressSession = data.inProgressSession || null;
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('calmrData', JSON.stringify({
                history: state.history,
                inProgressSession: state.inProgressSession
            }));
        }

        // Auto-save current session
        function autoSave() {
            state.inProgressSession = {
                type: state.currentView,
                step: state.currentStep,
                data: { ...state.sessionData },
                timestamp: new Date().toISOString()
            };
            saveData();
        }

        // Complete a session
        function completeSession() {
            const session = {
                type: state.currentView,
                data: { ...state.sessionData },
                timestamp: new Date().toISOString()
            };
            state.history.push(session);
            state.inProgressSession = null;
            state.sessionData = {};
            saveData();
        }

        // ============= RENDER FUNCTIONS =============
        function render() {
            const app = document.getElementById('app');
            
            switch(state.currentView) {
                case 'home':
                    app.innerHTML = renderHome();
                    break;
                case 'morning':
                    app.innerHTML = renderMorningCheckin();
                    break;
                case 'evening':
                    app.innerHTML = renderEveningCheckin();
                    break;
                case 'activated':
                    app.innerHTML = renderActivated();
                    break;
                case 'stats':
                    app.innerHTML = renderStats();
                    break;
                default:
                    app.innerHTML = renderHome();
            }
            
            attachEventListeners();
        }

        function renderHome() {
            const hasInProgress = state.inProgressSession !== null;
            const todayCheckins = getTodayCheckins();
            
            return `
                <div class="card">
                    <h1>Hey Josh! üëã</h1>
                    <p class="subtitle">Your daily check-in buddy</p>
                    ${hasInProgress ? `
                        <div class="info-box">
                            You've got an in-progress session from ${new Date(state.inProgressSession.timestamp).toLocaleString()} Want to pick up where you left off?
                            <div style="margin-top: 12px;">
                                <button onclick="resumeSession()" style="background: #3b82f6; padding: 8px 16px; font-size: 14px;">
                                    Resume Session
                                </button>
                                <button onclick="clearInProgress()" style="background: #94a3b8; padding: 8px 16px; font-size: 14px; margin-left: 8px;">
                                    Start Fresh
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${state.history.length}</div>
                            <div class="stat-label">Total Check-ins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${todayCheckins.morning ? '‚úì' : '‚Äî'}</div>
                            <div class="stat-label">Morning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${todayCheckins.evening ? '‚úì' : '‚Äî'}</div>
                            <div class="stat-label">Evening</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${getActivationCount()}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 24px;">
                        <button onclick="startCheckin('morning')">
                            <span class="button-icon">‚òÄÔ∏è</span>
                            <span>Morning Check-in</span>
                        </button>
                        
                        <button onclick="startCheckin('evening')">
                            <span class="button-icon">üåô</span>
                            <span>Evening Check-in</span>
                        </button>
                        
                        <button onclick="startCheckin('activated')" class="danger-button">
                            <span class="button-icon">üö®</span>
                            <span>I'm Activated Now</span>
                        </button>
                        
                        <button onclick="viewStats()" class="secondary-button">
                            <span class="button-icon">üìä</span>
                            <span>View Stats & Export Data</span>
                        </button>

                        <button onclick="openClaudeProject()" class="secondary-button">
                            <span class="button-icon">üí¨</span>
                            <span>Chat with Claude</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderMorningCheckin() {
            const steps = [
                renderSleepQuality,
                renderMoodEnergy,
                renderCarryover,
                renderLikelyTriggers,
                renderTriggerPreparation,
                renderLookingForward,
                renderMorningSummary
            ];

            if (state.currentStep >= steps.length) {
                return renderMorningSummary();
            }

            const progress = ((state.currentStep + 1) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>Morning Check-in</h2>
                    ${steps[state.currentStep]()}
                </div>
            `;
        }

        function renderSleepQuality() {
            const responses = {
                'Poor': "That's rough, especially with two little ones. Sleep deprivation is no joke.",
                'Fair': "Not great, not terrible. You're managing with what you've got.",
                'Good': "Nice! Good sleep makes everything more manageable.",
                'Great': "Hell yes! That's a solid foundation for the day."
            };
            
            return `
                <div class="question-section">
                    <label class="question-label">Hey Josh! How'd you sleep last night?</label>
                    <div class="radio-group">
                        ${['Poor', 'Fair', 'Good', 'Great'].map(option => `
                            <div class="radio-button ${state.sessionData.sleep === option ? 'selected' : ''}" 
                                 onclick="selectOption('sleep', '${option}')">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.sleep ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            ${responses[state.sessionData.sleep]}
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderMoodEnergy() {
            const responses = {
                'üòî Low': "I hear you. Starting the day already depleted is hard.",
                'üòê Okay': "Fair enough. You're showing up even when it's just okay.",
                'üôÇ Good': "Solid! That's a decent place to start from.",
                'üòä Great': "Love it! Ride that energy today."
            };
            
            return `
                <div class="question-section">
                    <label class="question-label">How's your mood and energy right now?</label>
                    <div class="radio-group">
                        ${['üòî Low', 'üòê Okay', 'üôÇ Good', 'üòä Great'].map(option => `
                            <div class="radio-button ${state.sessionData.mood === option ? 'selected' : ''}" 
                                 onclick="selectOption('mood', '${option}')">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.mood ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            ${responses[state.sessionData.mood]}
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderCarryover() {
            const showText = state.sessionData.carryover === 'yes';
            return `
                <div class="question-section">
                    <label class="question-label">Are you still feeling activated from something yesterday?</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        Sometimes stuff lingers into the next day.
                    </p>
                    <div class="radio-group">
                        <div class="radio-button ${state.sessionData.carryover === 'yes' ? 'selected' : ''}" 
                             onclick="selectOption('carryover', 'yes')">
                            Yes
                        </div>
                        <div class="radio-button ${state.sessionData.carryover === 'no' ? 'selected' : ''}" 
                             onclick="selectOption('carryover', 'no')">
                            No
                        </div>
                    </div>
                    ${showText ? `
                        <div style="margin-top: 16px;">
                            <p style="font-size: 14px; color: #4338ca; margin-bottom: 8px;">
                                Got it. Let's acknowledge that - What's still with you?
                            </p>
                            <textarea id="carryoverNote" placeholder="Brief note about what you're still feeling...">${state.sessionData.carryoverNote || ''}</textarea>
                        </div>
                    ` : state.sessionData.carryover === 'no' ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            Clean slate today. Nice.
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('carryoverNote', 'carryoverNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderLikelyTriggers() {
            return `
                <div class="question-section">
                    <label class="question-label">What might activate you today?</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        Let's prep for what's coming.
                    </p>
                    <div class="checkbox-group">
                        ${[
                            'Stressful to-do list',
                            'Social situations',
                            'Received feedback or undesirable responses',
                            'I made a mistake',
                            'Body/appearance concerns'
                        ].map(trigger => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.triggers || []).includes(trigger) ? 'checked' : ''}
                                       onchange="toggleCheckbox('triggers', '${trigger}')">
                                <span>${trigger}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="expandable-text">
                        <div class="expand-toggle" onclick="toggleExpand('triggerNote')">
                            üìù Add more context
                        </div>
                        <textarea id="triggerNote" class="hidden" placeholder="Anything specific you want to note...">${state.sessionData.triggerNote || ''}</textarea>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('triggerNote', 'triggerNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderTriggerPreparation() {
            const triggers = state.sessionData.triggers || [];
            
            // Skip this screen if no triggers selected
            if (triggers.length === 0) {
                state.currentStep++;
                return renderLookingForward();
            }

            return `
                <div class="question-section">
                    <label class="question-label">Alright, let's get you ready</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                        Here's how to meet today's challenges:
                    </p>
                    
                    ${triggers.includes('Stressful to-do list') ? `
                        <div style="padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                            <strong>üìÖ For stressful to-do list:</strong>
                            <p style="font-size: 14px; margin-top: 8px; color: #92400e;">
                                "If Perfect Pete shows up saying 'you need to do all these things', I'll ask if an outsider would think I am being 'extra'.
                                Instead, what would happen if this didn't get done? What is 'good enough' and what can be really set aside for another time?"
                            </p>
                        </div>
                    ` : ''}

                    ${triggers.includes('Social situations') ? `
                        <div style="padding: 16px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                            <strong>üë• For social situations:</strong>
                            <p style="font-size: 14px; margin-top: 8px; color: #1e40af;">
                                "If I start approval-scanning, I'll remember: I can just be here existing.
                                Their behavior is situational, not about my adequacy. I don't have to prove anything to anyone."
                            </p>
                        </div>
                    ` : ''}

                    ${triggers.includes('Received feedback or undesirable responses') ? `
                        <div style="padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                            <strong>üó£ Received feedback or undesirable responses:</strong>
                            <p style="font-size: 14px; margin-top: 8px; color: #92400e;">
                                "If I feel attacked, I can ask 'What really happened or was said?' 'What did I interpret it as saying?' and 'What would an outside observer say about it?'
                                Further, 'How much of what happened is more about them than me?'"
                            </p>
                        </div>
                    ` : ''}

                    ${triggers.includes('Family stress') ? `
                        <div style="padding: 16px; background: #e0e7ff; border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 12px;">
                            <strong>üõ†Ô∏è I made a mistake:</strong>
                            <p style="font-size: 14px; margin-top: 8px; color: #4338ca;">
                                "Making mistakes is human. I did the best I could with my capabilities. "
                            </p>
                        </div>
                    ` : ''}

                    ${triggers.includes('Body/appearance concerns') ? `
                        <div style="padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                            <strong>ü™û For body/appearance concerns:</strong>
                            <p style="font-size: 14px; margin-top: 8px; color: #92400e;">
                                "If body shame hits, I'll recognize this is perfectionism trying to prevent judgment.
                                I'm adequate regardless of appearance. I can investigate the urge if it comes."
                            </p>
                        </div>
                    ` : ''}

                    <div class="info-box" style="margin-top: 16px;">
                        <strong>Remember:</strong> You have your CALMR tools ready. You can handle what comes today.
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderLookingForward() {
            return `
                <div class="question-section">
                    <label class="question-label">What's one thing you're looking forward to today?</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        Even small things count! What's got a spark of good in it?
                    </p>
                    <div class="radio-group">
                        ${[
                            'Time with family',
                            'Good meal or coffee',
                            'Work progress',
                            'Exercise/movement',
                            'Learning something',
                            'Quiet moment',
                            'Other'
                        ].map(item => `
                            <div class="radio-button ${state.sessionData.lookingForward === item ? 'selected' : ''}" 
                                 onclick="selectOption('lookingForward', '${item}')"
                                 style="flex: 1 1 45%; text-align: center;">
                                ${item}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.lookingForward === 'Other' ? `
                        <div style="margin-top: 16px;">
                            <textarea id="lookingForwardDetail" placeholder="What are you looking forward to?">${state.sessionData.lookingForwardDetail || ''}</textarea>
                        </div>
                    ` : state.sessionData.lookingForward && state.sessionData.lookingForward !== 'Other' ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            Nice! That's something good to hold onto today.
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('lookingForwardDetail', 'lookingForwardDetail')" class="nav-button">Complete Check-in</button>
                </div>
            `;
        }

        function renderQuickWin() {
            return `
                <div class="question-section">
                    <label class="question-label">One thing that went well yesterday</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        Counter your negativity bias - name something positive!
                    </p>
                    <div class="radio-group">
                        ${[
                            'Used my tools when activated',
                            'Had a good conversation',
                            'Took care of myself',
                            'Made progress on work',
                            'Good family time',
                            'Other'
                        ].map(win => `
                            <div class="radio-button ${state.sessionData.quickWin === win ? 'selected' : ''}" 
                                 onclick="selectOption('quickWin', '${win}')"
                                 style="flex: 1 1 45%; text-align: center;">
                                ${win}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.quickWin === 'Other' ? `
                        <div style="margin-top: 16px;">
                            <textarea id="quickWinDetail" placeholder="What went well?">${state.sessionData.quickWinDetail || ''}</textarea>
                        </div>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('quickWinDetail', 'quickWinDetail')" class="nav-button">Complete Check-in</button>
                </div>
            `;
        }

        function renderMorningSummary() {
            completeSession();
            
            // Build personalized message based on what they shared
            let message = "You just showed up for yourself. ";
            
            if (state.sessionData.triggers && state.sessionData.triggers.length > 0) {
                message += "You've prepped for what might come today. ";
            }
            
            if (state.sessionData.lookingForward) {
                message += "You've got something to look forward to. ";
            }
            
            message += "Your CALMR tools are ready when you need them.";
            
            return `
                <div class="question-section">
                    <h2>‚úÖ Nice work, Josh!</h2>
                    <p style="color: #666; margin: 16px 0; font-size: 16px;">
                        ${message}
                    </p>
                    <div class="mantra-box">
                        "I'm doing the best I can. I'm good enough, right now, as I am."
                    </div>
                    <p style="font-size: 14px; color: #666; margin-top: 16px;">
                        Your CALMR tools are ready when you need them today. Come back tonight to check in on how it went.
                        Go do your thing today!
                    </p>
                </div>
                <div class="navigation-buttons">
                    <button onclick="goHome()" class="nav-button">Back to Home</button>
                </div>
            `;
        }

        function renderEveningCheckin() {
            const steps = [
                renderDayRating,
                renderSystemsActivated,
                renderToolUsage,
                renderPatternNotice,
                renderEveningWin,
                renderEveningSummary
            ];

            if (state.currentStep >= steps.length) {
                return renderEveningSummary();
            }

            const progress = ((state.currentStep + 1) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>Evening Check-in</h2>
                    ${steps[state.currentStep]()}
                </div>
            `;
        }

        function renderDayRating() {
            const responses = {
                'üòî Rough': "Yeah, some days are just hard. You made it through.",
                'üòê Okay': "Fair enough. Not every day has to be great.",
                'üôÇ Good': "Solid! You handled what came at you.",
                'üòä Great': "Hell yes! Take the win."
            };
            
            return `
                <div class="question-section">
                    <label class="question-label">How was your day overall?</label>
                    <div class="radio-group">
                        ${['üòî Rough', 'üòê Okay', 'üôÇ Good', 'üòä Great'].map(option => `
                            <div class="radio-button ${state.sessionData.dayRating === option ? 'selected' : ''}" 
                                 onclick="selectOption('dayRating', '${option}')">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.dayRating ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            ${responses[state.sessionData.dayRating]}
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderSystemsActivated() {
            return `
                <div class="question-section">
                    <label class="question-label">Did any of the usual suspects show up today?</label>
                    <div class="checkbox-group">
                        ${[
                            'üéØ Perfectionism',
                            'üíî Rejection/approval-seeking',
                            'üåÄ Habit urge',
                            '‚ú® None - calm day'
                        ].map(system => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.systems || []).includes(system) ? 'checked' : ''}
                                       onchange="toggleCheckbox('systems', '${system}')">
                                <span>${system}</span>
                            </label>
                        `).join('')}
                    </div>
                    ${state.sessionData.systems && state.sessionData.systems.includes('‚ú® None - calm day') ? `
                        <p style="margin-top: 12px; padding: 12px; background: #d1fae5; border-radius: 8px; color: #065f46; font-size: 14px;">
                            A calm day! Those are worth celebrating.
                        </p>
                    ` : state.sessionData.systems && state.sessionData.systems.length > 0 && !state.sessionData.systems.includes('‚ú® None - calm day') ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            Okay, they showed up. Let's see how you handled it.
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderToolUsage() {
            const hadActivation = state.sessionData.systems && 
                                  state.sessionData.systems.length > 0 && 
                                  !state.sessionData.systems.includes('‚ú® None - calm day');
            
            if (!hadActivation) {
                state.currentStep++;
                return renderPatternNotice();
            }

            return `
                <div class="question-section">
                    <label class="question-label">Did you catch it when you were activated?</label>
                    <div class="radio-group">
                        <div class="radio-button ${state.sessionData.caughtIt === 'yes' ? 'selected' : ''}" 
                             onclick="selectOption('caughtIt', 'yes')">
                            Yes
                        </div>
                        <div class="radio-button ${state.sessionData.caughtIt === 'no' ? 'selected' : ''}" 
                             onclick="selectOption('caughtIt', 'no')">
                            No
                        </div>
                    </div>

                    ${state.sessionData.caughtIt === 'yes' ? `
                        <p style="margin-top: 12px; padding: 12px; background: #d1fae5; border-radius: 8px; color: #065f46; font-size: 14px;">
                            Hell yes! That awareness is the whole game right there.
                        </p>
                        <div style="margin-top: 20px;">
                            <label class="question-label">Which tools did you use?</label>
                            <div class="checkbox-group">
                                ${[
                                    'CALMR system',
                                    'Chatted with Claude',
                                    'Outsider perspective',
                                    'Just paused and noticed',
                                    'Other'
                                ].map(tool => `
                                    <label class="checkbox-item">
                                        <input type="checkbox" 
                                               ${(state.sessionData.toolsUsed || []).includes(tool) ? 'checked' : ''}
                                               onchange="toggleCheckbox('toolsUsed', '${tool}')">
                                        <span>${tool}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    ` : state.sessionData.caughtIt === 'no' ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            That's okay. The pattern was faster than you this time. Happens.
                        </p>
                        <div class="expandable-text" style="margin-top: 16px;">
                            <div class="expand-toggle" onclick="toggleExpand('missedNote')">
                                üìù Notice anything about missing it?
                            </div>
                            <textarea id="missedNote" class="hidden" placeholder="Any insights about what made it hard to catch...">${state.sessionData.missedNote || ''}</textarea>
                        </div>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('missedNote', 'missedNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderPatternNotice() {
            return `
                <div class="question-section">
                    <label class="question-label">Any patterns you noticed today?</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        Optional - but helpful for tracking what triggers you
                    </p>
                    <div class="expandable-text">
                        <div class="expand-toggle" onclick="toggleExpand('patternNote')">
                            üìù Add observations
                        </div>
                        <textarea id="patternNote" class="hidden" placeholder="What did you notice?">${state.sessionData.patternNote || ''}</textarea>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('patternNote', 'patternNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderEveningWin() {
            return `
                <div class="question-section">
                    <label class="question-label">One thing that went well today</label>
                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                        End the day acknowledging something positive
                    </p>
                    <div class="radio-group">
                        ${[
                            'Used my tools',
                            'Good social interaction',
                            'Self-care moment',
                            'Work progress',
                            'Family connection',
                            'Other'
                        ].map(win => `
                            <div class="radio-button ${state.sessionData.eveningWin === win ? 'selected' : ''}" 
                                 onclick="selectOption('eveningWin', '${win}')"
                                 style="flex: 1 1 45%; text-align: center;">
                                ${win}
                            </div>
                        `).join('')}
                    </div>
                    ${state.sessionData.eveningWin === 'Other' ? `
                        <div style="margin-top: 16px;">
                            <textarea id="eveningWinDetail" placeholder="What went well?">${state.sessionData.eveningWinDetail || ''}</textarea>
                        </div>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('eveningWinDetail', 'eveningWinDetail')" class="nav-button">Complete Check-in</button>
                </div>
            `;
        }

        function renderEveningSummary() {
            completeSession();
            
            // Build personalized message based on their day
            let message = "";
            const hadActivation = state.sessionData.systems && state.sessionData.systems.length > 0 && !state.sessionData.systems.includes('‚ú® None - calm day');
            
            if (hadActivation && state.sessionData.caughtIt === 'yes') {
                message = "You caught yourself when it mattered. That's real progress. ";
                if (state.sessionData.toolsUsed && state.sessionData.toolsUsed.length > 0) {
                    message += "You used your tools. ";
                }
                message += "You're building the skill.";
            } else if (hadActivation && state.sessionData.caughtIt === 'no') {
                message = "The pattern was faster than you today. That happens. You're still showing up, still learning. Tomorrow's another shot at it.";
            } else {
                message = "A calm day is worth acknowledging. You handled what came your way.";
            }
            
            return `
                <div class="question-section">
                    <h2>‚úÖ You showed up today</h2>
                    <p style="color: #666; margin: 16px 0; font-size: 16px;">
                        ${message}
                    </p>
                    <div class="mantra-box">
                        "You did the best you can today! You are only human. You are good enough, just existing."
                    </div>
                    <p style="font-size: 14px; color: #666; margin-top: 16px;">
                        Rest well. Tomorrow's a new day.
                    </p>
                </div>
                <div class="navigation-buttons">
                    <button onclick="goHome()" class="nav-button">Back to Home</button>
                </div>
            `;
        }

        function renderActivated() {
            if (state.currentStep === 0) {
                return renderActivatedSelection();
            }

            // Handle different activation types
            const activationType = state.sessionData.activationType;

            if (activationType === 'üéØ Perfectionism') {
                return renderPerfectionismFlow();
            } else if (activationType === 'üíî Relationship Conflict') {
                return renderRelationshipConflictFlow();
            } else if (activationType === 'üíî Rejection') {
                return renderRejectionFlow();
            } else if (activationType === 'üåÄ Habit Urge') {
                return renderHabitUrgeFlow();
            } else if (activationType === 'üòî Already Engaged') {
                return renderAlreadyEngagedFlow();
            }

            return renderActivatedSelection();
        }

        function renderActivatedSelection() {
            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <h2>I'm here with you</h2>
                    <p class="subtitle">What's happening right now?</p>
                    <div class="button-group">
                        <button onclick="selectActivationType('üéØ Perfectionism')">
                            <span class="button-icon">üéØ</span>
                            <span>Perfect Pete is attacking</span>
                        </button>
                        <button onclick="selectActivationType('üíî Relationship Conflict')">
                            <span class="button-icon">üíî</span>
                            <span>Fight/disagreement with Franni</span>
                        </button>
                        <button onclick="selectActivationType('üíî Rejection')">
                            <span class="button-icon">üíî</span>
                            <span>Approval-scanning / feeling rejected</span>
                        </button>
                        <button onclick="selectActivationType('üåÄ Habit Urge')">
                            <span class="button-icon">üåÄ</span>
                            <span>Having a habit urge</span>
                        </button>
                        <button onclick="selectActivationType('üòî Already Engaged')">
                            <span class="button-icon">üòî</span>
                            <span>Already engaged in habit</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPerfectionismFlow() {
            const steps = [
                renderCapture,
                renderAssuage,
                renderLabelPerfectionism,
                renderModifyPerfectionism,
                renderReassure
            ];

            const progress = ((state.currentStep) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>CALMR: Perfectionism</h2>
                    ${steps[state.currentStep - 1]()}
                </div>
            `;
        }

        function renderRelationshipConflictFlow() {
            const steps = [
                renderCapture,
                renderAssuage,
                renderLabelRelationshipConflict,
                renderModifyRelationshipConflict,
                renderReassure
            ];

            const progress = ((state.currentStep) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>CALMR: Relationship Conflict</h2>
                    ${steps[state.currentStep - 1]()}
                </div>
            `;
        }

        function renderRejectionFlow() {
            const steps = [
                renderCapture,
                renderAssuage,
                renderLabelRejection,
                renderModifyRejection,
                renderReassure
            ];

            const progress = ((state.currentStep) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>CALMR: Rejection Pain</h2>
                    ${steps[state.currentStep - 1]()}
                </div>
            `;
        }

        function renderHabitUrgeFlow() {
            const steps = [
                renderCapture,
                renderAssuage,
                renderLabelHabit,
                renderModifyHabitUrge,
                renderReassure
            ];

            const progress = ((state.currentStep) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>CALMR: Habit Urge</h2>
                    ${steps[state.currentStep - 1]()}
                </div>
            `;
        }

        function renderAlreadyEngagedFlow() {
            const steps = [
                renderNameFeelings,
                renderOutsiderAfterHabit,
                renderReassureAfterHabit
            ];

            const progress = ((state.currentStep) / steps.length) * 100;

            return `
                <div class="home-icon" onclick="confirmExit()">üè†</div>
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <h2>After the Habit</h2>
                    ${steps[state.currentStep - 1]()}
                </div>
            `;
        }

        // ============= CALMR STEP COMPONENTS =============

        function renderCapture() {
            return `
                <div class="question-section">
                    <h3>C - CAPTURE</h3>
                    <p style="color: #666; margin-bottom: 12px;">
                        Let's locate what you're feeling in your body.
                    </p>
                    <label class="question-label">Where do you feel this?</label>
                    <div class="body-map">
                        ${['Chest', 'Jaw', 'Heart', 'Stomach', 'Shoulders', 'Throat', 'Head', 'Other'].map(part => `
                            <div class="body-part ${(state.sessionData.bodyParts || []).includes(part) ? 'selected' : ''}"
                                 onclick="toggleBodyPart('${part}')">
                                ${part}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 16px;">
                        <label class="question-label">What sensations?</label>
                        <div class="checkbox-group">
                            ${['Tight', 'Heavy', 'Racing', 'Clenched', 'Hot', 'Shaky'].map(sensation => `
                                <label class="checkbox-item">
                                    <input type="checkbox" 
                                           ${(state.sessionData.sensations || []).includes(sensation) ? 'checked' : ''}
                                           onchange="toggleCheckbox('sensations', '${sensation}')">
                                    <span>${sensation}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    ${(state.sessionData.bodyParts && state.sessionData.bodyParts.length > 0) || (state.sessionData.sensations && state.sessionData.sensations.length > 0) ? `
                        <p style="margin-top: 12px; padding: 12px; background: #e0e7ff; border-radius: 8px; color: #4338ca; font-size: 14px;">
                            Good. You're noticing it. That's the first step.
                        </p>
                    ` : ''}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderAssuage() {
            return `
                <div class="question-section">
                    <h3>A - ASSUAGE (1-2 minutes)</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Let's physically calm your nervous system. I'm here with you.
                    </p>
                    
                    <div class="breathing-circle">Breathe</div>
                    
                    <div class="info-box">
                        <strong>Do this now:</strong>
                        <ul style="margin-top: 8px; margin-left: 20px;">
                            <li>Take 3 deep breaths - in through nose, out through mouth</li>
                            <li>Feel your feet on the floor</li>
                            <li>Put your hand on your chest and feel your heartbeat</li>
                        </ul>
                    </div>

                    <div class="mantra-box">
                        "I am okay. I'm capable enough to handle this."
                        <br><br>
                        "This is hard, and I'm handling it."
                    </div>

                    <p style="font-size: 14px; color: #666; text-align: center; margin-top: 16px;">
                        Take your time. No rush. Click Next when you're ready.
                    </p>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderLabelPerfectionism() {
            return `
                <div class="question-section">
                    <h3>L - LABEL (30 sec - 1 min)</h3>
                    <label class="question-label">What are you feeling?</label>
                    <div class="checkbox-group">
                        ${['Anxious', 'Ashamed', 'Overwhelmed', 'Inadequate', 'Frustrated', 'Angry'].map(feeling => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.feelings || []).includes(feeling) ? 'checked' : ''}
                                       onchange="toggleCheckbox('feelings', '${feeling}')">
                                <span>${feeling}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="expandable-text">
                        <div class="expand-toggle" onclick="toggleExpand('feelingsNote')">
                            üìù Add more detail
                        </div>
                        <textarea id="feelingsNote" class="hidden" placeholder="Other feelings...">${state.sessionData.feelingsNote || ''}</textarea>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('feelingsNote', 'feelingsNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderLabelRejection() {
            return renderLabelPerfectionism(); // Same feelings apply
        }

        function renderLabelHabit() {
            return renderLabelPerfectionism(); // Same feelings apply
        }

        function renderLabelRelationshipConflict() {
            return `
                <div class="question-section">
                    <h3>L - LABEL (30 sec - 1 min)</h3>
                    <label class="question-label">What are you feeling right now?</label>
                    <div class="checkbox-group">
                        ${['Hurt', 'Defensive', 'Ashamed', 'Anxious', 'Angry', 'Frustrated', 'Desperate to fix it'].map(feeling => `
                            <label class="checkbox-item">
                                <input type="checkbox"
                                       ${(state.sessionData.feelings || []).includes(feeling) ? 'checked' : ''}
                                       onchange="toggleCheckbox('feelings', '${feeling}')">
                                <span>${feeling}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="expandable-text" style="margin-top: 16px;">
                        <div class="expand-toggle" onclick="toggleExpand('relationshipNote')">
                            üìù What happened? (optional - just for you)
                        </div>
                        <textarea id="relationshipNote" class="hidden" placeholder="Brief note about the conflict...">${state.sessionData.relationshipNote || ''}</textarea>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('relationshipNote', 'relationshipNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderModifyPerfectionism() {
            return `
                <div class="question-section">
                    <h3>M - MODIFY (3-5 minutes)</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        Choose how you want to work through this:
                    </p>
                    
                    <div class="button-group">
                        <button onclick="openClaudeWithContext()" style="background: #3b82f6;">
                            <span class="button-icon">üí¨</span>
                            <span>Start a chat with Claude</span>
                        </button>
                    </div>

                    <p style="text-align: center; margin: 16px 0; color: #666;">‚Äî or ‚Äî</p>

                    <label class="question-label">What is Perfect Pete saying?</label>
                    <div class="checkbox-group">
                        ${[
                            'I made a mistake',
                            'I got feedback/criticism',
                            'I have so much to do',
                            'Someone was rude to me',
                            'I must do this perfectly'
                        ].map(thought => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.peteThoughts || []).includes(thought) ? 'checked' : ''}
                                       onchange="toggleCheckbox('peteThoughts', '${thought}')">
                                <span>${thought}</span>
                            </label>
                        `).join('')}
                    </div>

                    ${renderPerfectionismQuestions()}
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderPerfectionismQuestions() {
            const thoughts = state.sessionData.peteThoughts || [];
            
            let questions = '';

            if (thoughts.includes('I made a mistake') || thoughts.includes('I got feedback/criticism')) {
                questions += `
                    <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <strong>Feedback Reality Check:</strong>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What actually happened? (their exact words/actions)
                            </label>
                            <textarea id="whatHappened" placeholder="Just the facts...">${state.sessionData.whatHappened || ''}</textarea>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What did my brain translate it to mean?
                            </label>
                            <textarea id="whatItMeant" placeholder="About my worth/competence...">${state.sessionData.whatItMeant || ''}</textarea>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What would a neutral outsider say?
                            </label>
                            <textarea id="outsiderView" placeholder="Normal perspective...">${state.sessionData.outsiderView || ''}</textarea>
                        </div>
                    </div>
                `;
            }

            if (thoughts.includes('I have so much to do') || thoughts.includes('I must do this perfectly')) {
                questions += `
                    <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <strong>Good Enough Filter:</strong>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 8px;">
                                Would an outsider think I'm being extra with this effort?
                            </label>
                            <div class="radio-group">
                                <div class="radio-button ${state.sessionData.beingExtra === 'yes' ? 'selected' : ''}" 
                                     onclick="selectOption('beingExtra', 'yes')">Yes</div>
                                <div class="radio-button ${state.sessionData.beingExtra === 'no' ? 'selected' : ''}" 
                                     onclick="selectOption('beingExtra', 'no')">No</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                If this doesn't get done perfectly, what actually happens?
                            </label>
                            <textarea id="whatHappensImperfect" placeholder="Real consequences...">${state.sessionData.whatHappensImperfect || ''}</textarea>
                        </div>
                    </div>
                `;
            }

            if (thoughts.includes('Someone was rude to me')) {
                questions += `
                    <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <strong>Appropriate Anger Check:</strong>
                        <div class="checkbox-group" style="margin-top: 12px;">
                            ${[
                                'They treated me like an object',
                                'That was unnecessarily harsh',
                                'I have a right to be annoyed',
                                'Their behavior was about them, not me'
                            ].map(check => `
                                <label class="checkbox-item">
                                    <input type="checkbox" 
                                           ${(state.sessionData.angerChecks || []).includes(check) ? 'checked' : ''}
                                           onchange="toggleCheckbox('angerChecks', '${check}')">
                                    <span>${check}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return questions;
        }

        function renderModifyRejection() {
            return `
                <div class="question-section">
                    <h3>M - MODIFY (3-5 minutes)</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        Choose how you want to work through this:
                    </p>
                    
                    <div class="button-group">
                        <button onclick="openClaudeWithContext()" style="background: #3b82f6;">
                            <span class="button-icon">üí¨</span>
                            <span>Start a chat with Claude</span>
                        </button>
                    </div>

                    <p style="text-align: center; margin: 16px 0; color: #666;">‚Äî or ‚Äî</p>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px;">
                        <strong>Situational vs Dispositional Check:</strong>
                        <p style="font-size: 14px; color: #666; margin: 8px 0;">
                            Is this about me (dispositional) or about circumstances/them/environment (situational)?
                        </p>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; margin-bottom: 8px;">
                                Alternative explanations to consider:
                            </label>
                            <div class="checkbox-group">
                                ${[
                                    'They\'re tired or distracted',
                                    'They\'re dealing with their own stuff',
                                    'Setting made interaction awkward',
                                    'Normal conversation flow',
                                    'They\'re bad at showing friendship',
                                    'They were being rude (about them, not me)'
                                ].map(explanation => `
                                    <label class="checkbox-item">
                                        <input type="checkbox" 
                                               ${(state.sessionData.alternatives || []).includes(explanation) ? 'checked' : ''}
                                               onchange="toggleCheckbox('alternatives', '${explanation}')">
                                        <span>${explanation}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px;">
                        <strong>Reality Perspective Check:</strong>
                        <div class="checkbox-group" style="margin-top: 12px;">
                            ${[
                                'I\'m imagining harsh judgments without evidence',
                                'I\'m being unfair by assuming they\'re judging me',
                                'They might be thinking neutral/positive things'
                            ].map(check => `
                                <label class="checkbox-item">
                                    <input type="checkbox" 
                                           ${(state.sessionData.realityChecks || []).includes(check) ? 'checked' : ''}
                                           onchange="toggleCheckbox('realityChecks', '${check}')">
                                    <span>${check}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <strong>Evidence I'm Already Liked:</strong>
                        <p style="font-size: 14px; color: #666; margin: 8px 0;">
                            For established relationships, what evidence do you have?
                        </p>
                        <div class="expandable-text">
                            <div class="expand-toggle" onclick="toggleExpand('evidenceNote')">
                                üìù Note the evidence
                            </div>
                            <textarea id="evidenceNote" class="hidden" placeholder="They invited me, they've reached out before, they've shared personal things...">${state.sessionData.evidenceNote || ''}</textarea>
                        </div>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('evidenceNote', 'evidenceNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderModifyRelationshipConflict() {
            return `
                <div class="question-section">
                    <h3>M - MODIFY (3-5 minutes)</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        Choose how you want to work through this:
                    </p>

                    <div class="button-group">
                        <button onclick="openClaudeWithContext()" style="background: #3b82f6;">
                            <span class="button-icon">üí¨</span>
                            <span>Start a chat with Claude</span>
                        </button>
                    </div>

                    <p style="text-align: center; margin: 16px 0; color: #666;">‚Äî or work through it here ‚Äî</p>

                    <div style="padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <strong>Her upset ‚â† Your inadequacy</strong>
                        <p style="font-size: 14px; margin-top: 8px; color: #92400e;">
                            "She's upset with me right now. That doesn't mean I'm a terrible husband or inadequate. It means we're having a hard moment."
                        </p>
                    </div>

                    <div style="padding: 16px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                        <strong>Separate the mistake from catastrophe</strong>
                        <p style="font-size: 14px; margin-top: 8px; color: #1e40af;">
                            "I did/said something that hurt her. That's true. AND I can repair this. One mistake doesn't mean I'm failing as a partner."
                        </p>
                    </div>

                    <div style="padding: 16px; background: #e0e7ff; border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 12px;">
                        <strong>Time-scale perspective</strong>
                        <p style="font-size: 14px; margin-top: 8px; color: #4338ca;">
                            "This feels enormous right now. In a week, we'll have worked through this. We've been through conflicts before and come out okay."
                        </p>
                    </div>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-top: 20px;">
                        <strong>What am I trying to do right now?</strong>
                        <div class="checkbox-group" style="margin-top: 12px;">
                            ${[
                                'Make her stop being upset (control)',
                                'Actually understand her perspective',
                                'Defend myself from feeling inadequate',
                                'Rush to fix without processing',
                                'Self-flagellate to prove I care',
                                'Be present for repair'
                            ].map(behavior => `
                                <label class="checkbox-item">
                                    <input type="checkbox"
                                           ${(state.sessionData.conflictBehaviors || []).includes(behavior) ? 'checked' : ''}
                                           onchange="toggleCheckbox('conflictBehaviors', '${behavior}')">
                                    <span>${behavior}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="info-box" style="margin-top: 16px;">
                        <strong>Remember:</strong> You can tolerate her being upset without it meaning you're inadequate. Repair is possible.
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="nextStep()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderModifyHabitUrge() {
            return `
                <div class="question-section">
                    <h3>M - MODIFY (3-5 minutes)</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        Let's investigate what's really happening:
                    </p>
                    
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button onclick="openClaudeWithContext()" style="background: #3b82f6;">
                            <span class="button-icon">üí¨</span>
                            <span>Chat with Claude for support</span>
                        </button>
                    </div>

                    <p style="text-align: center; margin: 16px 0; color: #666;">‚Äî or work through it here ‚Äî</p>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px;">
                        <strong>What triggered this urge?</strong>
                        <div class="checkbox-group" style="margin-top: 12px;">
                            ${[
                                'Stressed',
                                'Bored',
                                'Overwhelmed',
                                'Body shame',
                                'Procrastinating',
                                'Feeling disconnected'
                            ].map(trigger => `
                                <label class="checkbox-item">
                                    <input type="checkbox" 
                                           ${(state.sessionData.urgeTriggerse || []).includes(trigger) ? 'checked' : ''}
                                           onchange="toggleCheckbox('urgeTriggers', '${trigger}')">
                                    <span>${trigger}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="expandable-text">
                            <div class="expand-toggle" onclick="toggleExpand('triggerContext')">
                                üìù Add context
                            </div>
                            <textarea id="triggerContext" class="hidden" placeholder="What's really going on?">${state.sessionData.triggerContext || ''}</textarea>
                        </div>
                    </div>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px;">
                        <strong>What will actually happen?</strong>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What will get better?
                            </label>
                            <textarea id="whatGetsBetter" placeholder="Momentary stress relief, distraction, brief pleasure...">${state.sessionData.whatGetsBetter || ''}</textarea>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What will get worse?
                            </label>
                            <textarea id="whatGetsWorse" placeholder="Shame, self-attack afterward...">${state.sessionData.whatGetsWorse || ''}</textarea>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 4px;">
                                What won't change?
                            </label>
                            <textarea id="whatStaysSame" placeholder="Still tired, still stressed, underlying problems still there...">${state.sessionData.whatStaysSame || ''}</textarea>
                        </div>
                    </div>

                    <div class="info-box">
                        <strong>Remember:</strong> Making a conscious choice - even if you choose to engage - is progress. 
                        Pausing and investigating matters.
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureUrgeTextsAndNext()" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderNameFeelings() {
            return `
                <div class="question-section">
                    <h3>Name the Feelings</h3>
                    <label class="question-label">What are you feeling right now?</label>
                    <div class="checkbox-group">
                        ${['Shame', 'Irritability', 'Disappointment', 'Frustration', 'Self-attack'].map(feeling => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.afterFeelings || []).includes(feeling) ? 'checked' : ''}
                                       onchange="toggleCheckbox('afterFeelings', '${feeling}')">
                                <span>${feeling}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="expandable-text">
                        <div class="expand-toggle" onclick="toggleExpand('afterFeelingsNote')">
                            üìù Add more detail
                        </div>
                        <textarea id="afterFeelingsNote" class="hidden" placeholder="Other feelings...">${state.sessionData.afterFeelingsNote || ''}</textarea>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="captureTextAndNext('afterFeelingsNote', 'afterFeelingsNote')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderOutsiderAfterHabit() {
            return `
                <div class="question-section">
                    <h3>Outsider Perspective</h3>
                    <div class="mantra-box">
                        "A neutral observer would say: You engaged the habit under stress. This makes sense - it's how you've always responded to this scenario. Of course you would do it that way. But this doesn't erase weeks of work or make you a failure."
                    </div>

                    <div style="margin-top: 20px;">
                        <label class="question-label">What triggered this tonight?</label>
                        <textarea id="habitTrigger" placeholder="What was happening before the urge?">${state.sessionData.habitTrigger || ''}</textarea>
                    </div>

                    <div class="info-box" style="margin-top: 16px;">
                        <strong>Perfectionism Interrupt:</strong>
                        <ul style="margin-top: 8px; margin-left: 20px;">
                            <li>I'm capable of managing my life even with this habit</li>
                            <li>I am still adequate as a person</li>
                            <li>This doesn't erase my progress</li>
                        </ul>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="prevStep()" class="nav-button back-button">Back</button>
                    <button onclick="captureTextAndNext('habitTrigger', 'habitTrigger')" class="nav-button">Next</button>
                </div>
            `;
        }

        function renderReassureAfterHabit() {
            return `
                <div class="question-section">
                    <h3>What Actually Helps Now?</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        You've interrupted the shame spiral. That's huge.
                    </p>

                    <div class="mantra-box">
                        "I'm capable of managing my life even with this setback. This doesn't make me inadequate."
                    </div>

                    <label class="question-label" style="margin-top: 20px;">What do you need right now?</label>
                    <div class="checkbox-group">
                        ${[
                            'Sleep',
                            'Water',
                            'Self-compassion',
                            'Talk to Claude tomorrow morning',
                            'Just move forward'
                        ].map(need => `
                            <label class="checkbox-item">
                                <input type="checkbox" 
                                       ${(state.sessionData.needs || []).includes(need) ? 'checked' : ''}
                                       onchange="toggleCheckbox('needs', '${need}')">
                                <span>${need}</span>
                            </label>
                        `).join('')}
                    </div>

                    <div class="info-box" style="margin-top: 20px;">
                        This will be noted for your morning check-in tomorrow. You're not alone in this.
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button onclick="completeAndGoHome()" class="nav-button">Complete & Go Home</button>
                </div>
            `;
        }

        function renderReassure() {
            const activationType = state.sessionData.activationType;
            let mantra = "I'm capable enough. I'm adequate as I am.";

            if (activationType === 'üéØ Perfectionism') {
                mantra = "I'm competent even when I make mistakes. Mistakes don't mean I'm inadequate.";
            } else if (activationType === 'üíî Relationship Conflict') {
                mantra = "I'm a capable partner who made a mistake, not an inadequate partner who got revealed. We can work through this.";
            } else if (activationType === 'üíî Rejection') {
                mantra = "I'm adequate even when not everyone likes me. I don't need universal approval to be okay.";
            } else if (activationType === 'üåÄ Habit Urge') {
                mantra = "I'm capable of handling my life even when I engage in the habit. This doesn't mean I'm inadequate or out of control.";
            }

            return `
                <div class="question-section">
                    <h3>R - REASSURE (1 minute)</h3>
                    <p style="color: #666; margin-bottom: 16px;">
                        Ground yourself after the cognitive work
                    </p>

                    <div class="mantra-box">
                        ${mantra}
                    </div>

                    <div style="padding: 16px; background: #f8fafc; border-radius: 8px; margin: 20px 0;">
                        <strong>Evidence reminder:</strong>
                        <p style="font-size: 14px; color: #666; margin-top: 8px;">
                            Think of evidence that you're actually adequate: one thing you've handled well recently, one person who values you, one area where you're clearly competent
                        </p>
                    </div>

                    <label class="question-label">Reflection check-in:</label>
                    <div style="margin: 12px 0;">
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                            <span style="flex: 1; font-size: 14px;">Are you still activated?</span>
                            <div class="radio-group" style="flex: 1;">
                                <div class="radio-button ${state.sessionData.stillActivated === 'yes' ? 'selected' : ''}" 
                                     onclick="selectOptionNoNav('stillActivated', 'yes')" style="flex: 1;">Yes</div>
                                <div class="radio-button ${state.sessionData.stillActivated === 'no' ? 'selected' : ''}" 
                                     onclick="selectOptionNoNav('stillActivated', 'no')" style="flex: 1;">No</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span style="flex: 1; font-size: 14px;">Is it tolerable now?</span>
                            <div class="radio-group" style="flex: 1;">
                                <div class="radio-button ${state.sessionData.tolerable === 'yes' ? 'selected' : ''}" 
                                     onclick="selectOptionNoNav('tolerable', 'yes')" style="flex: 1;">Yes</div>
                                <div class="radio-button ${state.sessionData.tolerable === 'no' ? 'selected' : ''}" 
                                     onclick="selectOptionNoNav('tolerable', 'no')" style="flex: 1;">No</div>
                            </div>
                        </div>
                    </div>

                    <div class="info-box">
                        Remember: You won't be fully calm - you'll be CALMER. Still activated but at a manageable level.
                    </div>

                    <div id="supportSection">
                        ${state.sessionData.tolerable === 'no' ? `
                            <div style="margin-top: 16px;">
                                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    Still struggling? That's okay. You've done the work - sometimes it just takes time.
                                </p>
                                <button onclick="openClaudeWithContext()" class="secondary-button" style="width: 100%;">
                                    <span class="button-icon">üí¨</span>
                                    <span>Talk to Claude for more support</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <p style="font-size: 14px; color: #666; text-align: center; margin-top: 16px;">
                        You showed up for yourself. That's what matters.
                    </p>
                </div>
                <div class="navigation-buttons">
                    <button onclick="completeAndGoHome()" class="nav-button">Complete & Go Home</button>
                </div>
            `;
        }

        function renderStats() {
            const stats = calculateStats();
            
            return `
                <div class="home-icon" onclick="goHome()">üè†</div>
                <div class="card">
                    <h2>Your Stats & Patterns</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.totalCheckins}</div>
                            <div class="stat-label">Total Check-ins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.morningCheckins}</div>
                            <div class="stat-label">Morning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.eveningCheckins}</div>
                            <div class="stat-label">Evening</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.activations}</div>
                            <div class="stat-label">Activations</div>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <h3>System Breakdown</h3>
                        <div style="margin-top: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üéØ Perfectionism:</span>
                                <strong>${stats.perfectionism}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üíî Relationship Conflict:</span>
                                <strong>${stats.relationshipConflict}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üíî Rejection/Approval:</span>
                                <strong>${stats.rejection}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>üåÄ Habit Urge:</span>
                                <strong>${stats.habitUrge}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>üòî After Habit:</span>
                                <strong>${stats.afterHabit}</strong>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <h3>Recent Activity</h3>
                        <div style="max-height: 300px; overflow-y: auto; margin-top: 12px;">
                            ${state.history.slice().reverse().slice(0, 10).map((session, index) => {
                                const actualIndex = state.history.length - 1 - index;
                                return `
                                <div style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <strong>${getSessionIcon(session.type)} ${session.type}</strong>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                            ${new Date(session.timestamp).toLocaleString()}
                                        </div>
                                    </div>
                                    <button onclick="deleteHistoryItem(${actualIndex})" 
                                            style="background: #ef4444; padding: 6px 12px; font-size: 12px; border: none; border-radius: 6px; color: white; cursor: pointer;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 24px;">
                        <button onclick="exportData()" class="secondary-button">
                            <span class="button-icon">üì•</span>
                            <span>Export Data for Claude Analysis</span>
                        </button>
                        
                        <button onclick="clearAllData()" class="danger-button">
                            <span class="button-icon">üóëÔ∏è</span>
                            <span>Clear All Data</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // ============= HELPER FUNCTIONS =============

        function getTodayCheckins() {
            const today = new Date().toDateString();
            const todaySessions = state.history.filter(s => 
                new Date(s.timestamp).toDateString() === today
            );
            
            return {
                morning: todaySessions.some(s => s.type === 'morning'),
                evening: todaySessions.some(s => s.type === 'evening')
            };
        }

        function getActivationCount() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            return state.history.filter(s => 
                s.type === 'activated' && new Date(s.timestamp) > weekAgo
            ).length;
        }

        function getSessionIcon(type) {
            const icons = {
                'morning': '‚òÄÔ∏è',
                'evening': 'üåô',
                'activated': 'üö®'
            };
            return icons[type] || 'üìù';
        }

        function calculateStats() {
            const stats = {
                totalCheckins: state.history.length,
                morningCheckins: 0,
                eveningCheckins: 0,
                activations: 0,
                perfectionism: 0,
                relationshipConflict: 0,
                rejection: 0,
                habitUrge: 0,
                afterHabit: 0
            };

            state.history.forEach(session => {
                if (session.type === 'morning') stats.morningCheckins++;
                if (session.type === 'evening') stats.eveningCheckins++;
                if (session.type === 'activated') {
                    stats.activations++;
                    const activationType = session.data.activationType;
                    if (activationType === 'üéØ Perfectionism') stats.perfectionism++;
                    if (activationType === 'üíî Relationship Conflict') stats.relationshipConflict++;
                    if (activationType === 'üíî Rejection') stats.rejection++;
                    if (activationType === 'üåÄ Habit Urge') stats.habitUrge++;
                    if (activationType === 'üòî Already Engaged') stats.afterHabit++;
                }
            });

            return stats;
        }

        // ============= EVENT HANDLERS =============

        function startCheckin(type) {
            state.currentView = type;
            state.currentStep = type === 'activated' ? 0 : 0;
            state.sessionData = {};
            render();
        }

        function selectActivationType(type) {
            state.sessionData.activationType = type;
            state.currentStep = 1;
            autoSave();
            render();
        }

        function nextStep() {
            state.currentStep++;
            autoSave();
            render();
        }

        function prevStep() {
            state.currentStep--;
            render();
        }

        function selectOption(key, value) {
            state.sessionData[key] = value;
            autoSave();
            render();
        }

        function selectOptionNoNav(key, value) {
            state.sessionData[key] = value;
            autoSave();
            // Update just the support section if it exists
            const supportSection = document.getElementById('supportSection');
            if (supportSection && key === 'tolerable') {
                if (value === 'no') {
                    supportSection.innerHTML = `
                        <div style="margin-top: 16px;">
                            <p style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                Still struggling? That's okay. You've done the work - sometimes it just takes time.
                            </p>
                            <button onclick="openClaudeWithContext()" class="secondary-button" style="width: 100%;">
                                <span class="button-icon">üí¨</span>
                                <span>Talk to Claude for more support</span>
                            </button>
                        </div>
                    `;
                } else {
                    supportSection.innerHTML = '';
                }
            }
            // Update button styling without re-rendering
            document.querySelectorAll('.radio-button').forEach(btn => {
                if (btn.getAttribute('onclick')?.includes(`'${key}'`)) {
                    if (btn.getAttribute('onclick')?.includes(`'${value}'`)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                }
            });
        }

        function completeAndGoHome() {
            completeSession();
            goHome();
        }

        function toggleCheckbox(key, value) {
            if (!state.sessionData[key]) {
                state.sessionData[key] = [];
            }
            
            const index = state.sessionData[key].indexOf(value);
            if (index > -1) {
                state.sessionData[key].splice(index, 1);
            } else {
                state.sessionData[key].push(value);
            }
            autoSave();
            render();
        }

        function toggleBodyPart(part) {
            if (!state.sessionData.bodyParts) {
                state.sessionData.bodyParts = [];
            }
            
            const index = state.sessionData.bodyParts.indexOf(part);
            if (index > -1) {
                state.sessionData.bodyParts.splice(index, 1);
            } else {
                state.sessionData.bodyParts.push(part);
            }
            autoSave();
            render();
        }

        function toggleExpand(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
            }
        }

        function captureTextAndNext(elementId, dataKey) {
            const element = document.getElementById(elementId);
            if (element) {
                state.sessionData[dataKey] = element.value;
            }
            nextStep();
        }

        function captureUrgeTextsAndNext() {
            ['triggerContext', 'whatGetsBetter', 'whatGetsWorse', 'whatStaysSame'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    state.sessionData[id] = element.value;
                }
            });
            
            // Capture perfectionism texts if they exist
            ['whatHappened', 'whatItMeant', 'outsiderView', 'whatHappensImperfect'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    state.sessionData[id] = element.value;
                }
            });
            
            nextStep();
        }

        function resumeSession() {
            if (state.inProgressSession) {
                state.currentView = state.inProgressSession.type;
                state.currentStep = state.inProgressSession.step;
                state.sessionData = { ...state.inProgressSession.data };
                render();
            }
        }

        function clearInProgress() {
            state.inProgressSession = null;
            saveData();
            render();
        }

        function goHome() {
            state.currentView = 'home';
            state.currentStep = 0;
            state.sessionData = {};
            render();
        }

        function viewStats() {
            state.currentView = 'stats';
            render();
        }

        function confirmExit() {
            if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
                goHome();
            }
        }

        function openClaudeProject() {
            window.location.href = 'claude://';
        }

        function openClaudeWithContext() {
            // Open Claude app - user will navigate to project manually
            window.location.href = 'claude://';
        }

        function generateContextMessage() {
            const type = state.sessionData.activationType || state.currentView;
            let message = `I'm checking in from my CALMR app.\n\n`;
            
            if (state.sessionData.activationType) {
                message += `**Activation Type:** ${state.sessionData.activationType}\n\n`;
            }
            
            if (state.sessionData.bodyParts && state.sessionData.bodyParts.length > 0) {
                message += `**Physical sensations:** ${state.sessionData.bodyParts.join(', ')}\n`;
            }
            
            if (state.sessionData.sensations && state.sessionData.sensations.length > 0) {
                message += `**Feeling:** ${state.sessionData.sensations.join(', ')}\n`;
            }
            
            if (state.sessionData.feelings && state.sessionData.feelings.length > 0) {
                message += `**Emotions:** ${state.sessionData.feelings.join(', ')}\n`;
            }
            
            if (state.sessionData.peteThoughts && state.sessionData.peteThoughts.length > 0) {
                message += `**Perfect Pete is saying:** ${state.sessionData.peteThoughts.join(', ')}\n`;
            }
            
            if (state.sessionData.urgeTriggers && state.sessionData.urgeTriggers.length > 0) {
                message += `**Urge triggered by:** ${state.sessionData.urgeTriggers.join(', ')}\n`;
            }
            
            message += `\nHelp me work through this.`;
            
            return message;
        }

        function exportData() {
            const exportData = {
                exportDate: new Date().toISOString(),
                summary: calculateStats(),
                sessions: state.history
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `calmr-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                if (confirm('Really sure? All your check-ins and progress will be deleted.')) {
                    localStorage.removeItem('calmrData');
                    state.history = [];
                    state.inProgressSession = null;
                    alert('All data cleared.');
                    goHome();
                }
            }
        }

        function deleteHistoryItem(index) {
            if (confirm('Delete this check-in from your history?')) {
                state.history.splice(index, 1);
                saveData();
                render();
            }
        }

        function attachEventListeners() {
            // Event listeners are attached via onclick in the HTML
            // This function is here for any dynamic listeners we might need
        }

        // ============= INITIALIZATION =============
        loadData();
        render();

        // ============= PWA MANIFEST =============
        const manifest = {
            "name": "CALMR Check-In",
            "short_name": "CALMR",
            "description": "Your daily self-worth accountability system",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#667eea",
            "orientation": "portrait-primary",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üßò</text></svg>",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
</body>
</html>
